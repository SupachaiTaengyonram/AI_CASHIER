{% extends 'aicashier/base.html' %}
{% load static %}

{% block navbar %}
<nav class="bg-[#23243a] py-4 px-8 flex items-center justify-between shadow-lg z-20 relative">
  <div class="flex items-center gap-4">
    <span class="text-2xl font-bold text-[#b16cff] tracking-wide">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
    <span class="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full animate-pulse" id="status-indicator">üü¢ ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
  </div>
  <div class="flex items-center gap-4">
    <div class="text-gray-400 text-sm mr-4">
       ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á: <span id="visible-count" class="text-white font-bold">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
    </div>
    <form method="post" action="{% url 'logout' %}">
      {% csrf_token %}
      <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition text-sm shadow-md">
        ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
      </button>
    </form>
  </div>
</nav>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-[#1a1b2e] font-kanit p-6 overflow-hidden">
  <div class="max-w-[1920px] mx-auto">
    
    <div class="flex justify-between items-end mb-6 px-2">
      <div>
        <h1 class="text-3xl font-bold text-white mb-1">‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏ß‡∏°</h1>
        <p class="text-gray-400 text-sm">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡∏ï‡πà‡∏≠): <span class="text-[#b16cff] font-bold" id="total-cards-count">0</span> ‡πÉ‡∏ö</p>
      </div>
      <div class="flex gap-4">
         <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-blue-500"></div> <span class="text-gray-300 text-sm">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
         </div>
         <div class="flex items-center gap-2">
            <div class="w-3 h-3 rounded-full bg-[#b16cff]"></div> <span class="text-gray-300 text-sm">‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå</span>
         </div>
      </div>
    </div>

    <div id="master-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 auto-rows-fr" style="min-height: 860px;">
        </div>

    <div id="raw-data-container" class="hidden">
        {% for customer_group in counter_orders %}
        <div class="raw-order-data"
             data-type="counter"
             data-order-id="{{ customer_group.orders.0.id }}"
             data-order-number="{% if customer_group.order_number %}#{{ customer_group.order_number }}{% else %}#{{ customer_group.orders.0.id }}{% endif %}"
             data-customer="{{ customer_group.customer.username }}"
             data-time="{{ customer_group.created_at|date:'H:i' }}"
             data-total-price="{{ customer_group.total_price }}"
             data-raw-items='[
                {% for item in customer_group.items_detail %}
                    {"name": "{{ item.product_name }}", "qty": {{ item.quantity }}, "subtotal": "{{ item.subtotal }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
             ]'></div>
        {% endfor %}

        {% for customer_group in online_orders %}
        <div class="raw-order-data"
             data-type="online"
             data-order-id="{{ customer_group.orders.0.id }}"
             data-order-number="{% if customer_group.order_number %}#{{ customer_group.order_number }}{% else %}#{{ customer_group.orders.0.id }}{% endif %}"
             data-customer="{{ customer_group.customer.username }}"
             data-time="{{ customer_group.created_at|date:'H:i' }}"
             data-total-price="{{ customer_group.total_price }}"
             data-raw-items='[
                {% for item in customer_group.items_detail %}
                    {"name": "{{ item.product_name }}", "qty": {{ item.quantity }}, "subtotal": "{{ item.subtotal }}"}{% if not forloop.last %},{% endif %}
                {% endfor %}
             ]'></div>
        {% endfor %}
    </div>

    <div id="pagination-controls" class="flex justify-center mt-6 gap-4 items-center hidden">
        <button onclick="changePage(-1)" id="btn-prev" class="px-6 py-2 bg-[#2b2d47] text-white rounded-lg hover:bg-[#393a5a] disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-2 border border-white/10">
            <span></span> ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        </button>

        <span class="px-6 py-2 bg-[#393a5a] text-white rounded-lg font-mono border border-white/10 shadow-inner">
            Page <span id="current-page-display" class="font-bold text-[#b16cff]">1</span> 
            / <span id="total-pages-display">1</span>
        </span>

        <button onclick="changePage(1)" id="btn-next" class="px-6 py-2 bg-[#2b2d47] text-white rounded-lg hover:bg-[#393a5a] disabled:opacity-30 disabled:cursor-not-allowed transition-all flex items-center gap-2 border border-white/10">
            ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ <span></span>
        </button>
    </div>
    
    <div id="no-order-msg" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-center">
        <div class="text-6xl mb-4 animate-bounce">‚òïÔ∏è</div>
        <p class="text-gray-400 text-xl">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡πâ‡∏≤‡∏á ‡∏î‡∏∑‡πà‡∏°‡∏Å‡∏≤‡πÅ‡∏ü‡∏£‡∏≠‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!</p>
    </div>

    {% if is_paginated %}
    <div class="text-center mt-4">
        <p class="text-xs text-gray-500">
            ‡∏°‡∏µ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏µ‡∏Å‡∏°‡∏≤‡∏Å (‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà {{ page_obj.number }} ‡∏à‡∏≤‡∏Å {{ page_obj.paginator.num_pages }})
            {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}" class="text-[#b16cff] underline ml-2">‡πÇ‡∏´‡∏•‡∏î‡∏ä‡∏∏‡∏î‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</a>
            {% endif %}
        </p>
    </div>
    {% endif %}

  </div>
</div>

<script>
// --- CONFIGURATION ---
const MAX_ITEMS_PER_CARD = 4; // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÉ‡∏ö (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏∞‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ö‡πÉ‡∏´‡∏°‡πà)
const SLOTS_PER_PAGE = 8;     // 4x2 grid

// --- GLOBAL VARIABLES ---
let allGeneratedCards = [];   // ‡πÄ‡∏Å‡πá‡∏ö DOM Element ‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß
let currentPage = 1;
let totalPages = 1;

// --- MAIN LOGIC ---
function organizeAndSplitOrders() {
    const rawDataElements = Array.from(document.querySelectorAll('.raw-order-data'));
    
    // 1. Reset
    allGeneratedCards = [];
    
    // 2. Process Data -> Create Cards
    rawDataElements.forEach(dataEl => {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å data attributes
        const items = JSON.parse(dataEl.dataset.rawItems);
        const type = dataEl.dataset.type;
        const totalItems = items.length;
        
        // ‡πÅ‡∏ö‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô Chunk
        let chunks = [];
        if (totalItems === 0) {
            // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏Å‡∏±‡∏ô error)
        } else {
            for (let i = 0; i < totalItems; i += MAX_ITEMS_PER_CARD) {
                chunks.push(items.slice(i, i + MAX_ITEMS_PER_CARD));
            }
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML Card ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞ Chunk
        chunks.forEach((chunkItems, index) => {
            const isContinuation = index > 0; // ‡πÉ‡∏ö‡∏ó‡∏µ‡πà 2 ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ
            const isLastChunk = index === chunks.length - 1; // ‡πÉ‡∏ö‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢
            
            const newCard = document.createElement('div');
            
            // Style settings
            const baseBg = type === 'counter' ? 'bg-blue-900/20 border-blue-500/50' : 'bg-[#2b2d47] border-[#b16cff]/50';
            const hoverBorder = type === 'counter' ? 'hover:border-blue-400' : 'hover:border-[#d4a1ff]';
            
            // ‡πÉ‡∏ä‡πâ Flexbox ‡∏à‡∏±‡∏î layout ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô (h-[420px])
            newCard.className = `${baseBg} rounded-xl border shadow-lg flex flex-col h-[420px] relative overflow-hidden group ${hoverBorder} transition-all duration-300 p-5`;
            
            // Header Info
            const orderNumDisplay = isContinuation ? `${dataEl.dataset.orderNumber} (‡∏ï‡πà‡∏≠)` : dataEl.dataset.orderNumber;
            const badgeColor = type === 'counter' ? 'bg-blue-500/20 text-blue-300' : 'bg-[#b16cff]/20 text-[#d4a1ff]';
            const badgeText = type === 'counter' ? '‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô' : '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
            const btnColor = type === 'counter' ? 'from-blue-600 to-blue-700' : 'from-green-600 to-green-700';

            // Items HTML
            let itemsHtml = '';
            chunkItems.forEach(item => {
                itemsHtml += `
                <div class="flex justify-between items-start py-2 border-b border-white/5 last:border-0">
                    <div class="flex-1 pr-2">
                        <p class="text-white text-sm font-medium leading-tight">${item.name}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-lg font-bold ${type==='counter'?'text-blue-300':'text-[#b16cff]'}">x${item.qty}</span>
                    </div>
                </div>`;
            });

            // Action Button / Continuation Badge
            const actionArea = isLastChunk ? `
                <button onclick="completeOrder(${dataEl.dataset.orderId})" class="w-full py-3 rounded-lg bg-gradient-to-r ${btnColor} text-white font-bold hover:brightness-110 transition shadow-lg mt-auto active:scale-95 transform">
                    ‚úì ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô
                </button>
            ` : `
                <div class="w-full py-3 rounded-lg bg-white/5 text-gray-500 font-medium text-center mt-auto text-sm border border-white/10 cursor-help" title="‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ï‡πà‡∏≠‡πÉ‡∏ô‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ">
                    ‡∏î‡∏π‡∏ï‡πà‡∏≠‡πÉ‡∏ö‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚ûú
                </div>
            `;

            // HTML Structure
            newCard.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <div>
                        <h3 class="text-2xl font-bold text-white tracking-tight">${orderNumDisplay}</h3>
                        <p class="text-xs text-gray-400 mt-1">üïí ${dataEl.dataset.time}</p>
                    </div>
                    <span class="${badgeColor} text-xs px-3 py-1 rounded-full font-semibold border border-white/10">
                        ${badgeText}
                    </span>
                </div>

                <div class="mb-3">
                    <p class="text-gray-400 text-sm">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤: <span class="text-white font-medium">${dataEl.dataset.customer}</span></p>
                </div>

                <div class="bg-[#151625] rounded-lg p-3 flex-1 mb-3 border border-white/5 overflow-hidden">
                    ${itemsHtml}
                </div>

                ${isLastChunk ? `
                <div class="flex justify-between items-end mb-3 px-1">
                    <span class="text-gray-400 text-xs">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
                    <span class="text-xl font-bold text-white">${dataEl.dataset.totalPrice} ‡∏ø</span>
                </div>` : ''}

                ${actionArea}
            `;

            allGeneratedCards.push(newCard);
        });
    });

    // 3. Setup Pagination state
    totalPages = Math.ceil(allGeneratedCards.length / SLOTS_PER_PAGE);
    if (totalPages === 0) totalPages = 1;
    
    document.getElementById('total-cards-count').innerText = allGeneratedCards.length;
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
    renderCurrentPage();
}

function renderCurrentPage() {
    const gridContainer = document.getElementById('master-grid');
    const noOrderMsg = document.getElementById('no-order-msg');
    const paginationControls = document.getElementById('pagination-controls');
    
    // Clear Grid
    gridContainer.innerHTML = '';
    
    if (allGeneratedCards.length === 0) {
        noOrderMsg.classList.remove('hidden');
        paginationControls.classList.add('hidden');
        document.getElementById('visible-count').innerText = 0;
        return;
    } 
    
    noOrderMsg.classList.add('hidden');
    paginationControls.classList.remove('hidden');

    // Calculate Slice
    const startIndex = (currentPage - 1) * SLOTS_PER_PAGE;
    const endIndex = startIndex + SLOTS_PER_PAGE;
    const cardsToShow = allGeneratedCards.slice(startIndex, endIndex);

    // Append Cards with Animation
    cardsToShow.forEach((card, idx) => {
        // Reset animation logic to simple css class
        card.style.opacity = '0';
        card.style.animation = `slideIn 0.3s ease-out ${idx * 0.05}s forwards`;
        gridContainer.appendChild(card);
    });

    // Update UI Texts
    document.getElementById('visible-count').innerText = cardsToShow.length;
    document.getElementById('current-page-display').innerText = currentPage;
    document.getElementById('total-pages-display').innerText = totalPages;

    // Update Button States
    document.getElementById('btn-prev').disabled = (currentPage === 1);
    document.getElementById('btn-next').disabled = (currentPage === totalPages);
}

function changePage(direction) {
    const newPage = currentPage + direction;
    if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderCurrentPage();
    }
}

// --- STANDARD FUNCTIONS (Sound & API) ---
const audioContext = new (window.AudioContext || window.webkitAudioContext)();
function playNotificationSound() { /* ... ‡πÉ‡∏™‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ... */ }

function startOrderStream() {
  const eventSource = new EventSource('{% url "api_order_stream" %}');
  eventSource.onmessage = function(event) {
    const order = JSON.parse(event.data);
    if (order.type === 'new_order') {
        playNotificationSound();
        // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Server (Django Pagination 50 Items) 
        // ‡πÅ‡∏•‡πâ‡∏ß JS ‡∏à‡∏∞‡∏°‡∏≤‡∏à‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏≠‡∏á
        location.reload(); 
    }
  };
}

async function completeOrder(orderId) {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô?')) return;
    try {
        const response = await fetch('{% url "api_complete_order" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ order_id: orderId })
        });
        const data = await response.json();
        if (data.success) {
            // ‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏Ñ‡∏∑‡∏≠ reload ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            location.reload();
        }
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    organizeAndSplitOrders();
    startOrderStream();
});
</script>

<style>
@keyframes slideIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
</style>
{% endblock %}