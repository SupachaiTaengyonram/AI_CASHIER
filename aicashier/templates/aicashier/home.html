{% extends 'aicashier/base.html' %}
{% load static %}

{% block navbar %}
<nav class="bg-[#2d2d4a] py-3 px-4 sm:px-6 lg:px-8 flex flex-wrap md:flex-nowrap items-center justify-between border-b border-[#393a5a] min-h-[70px] flex-shrink-0 gap-2">
    <div class="flex items-center gap-4 sm:gap-8 flex-shrink-0">
        <a href="{% url 'home' %}" class="text-xl sm:text-2xl font-bold text-[#b16cff]">AI CASHIER</a>
        <!-- ‡πÅ‡∏™‡∏î‡∏á role ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ -->
        {% if user.is_staff and user.staff_role == 'cashier' %}
        <span class="text-xs sm:text-sm px-2 sm:px-3 py-1 bg-[#b16cff]/20 text-[#b16cff] rounded-full border border-[#b16cff]/30">‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</span>
        {% elif user.is_staff and user.staff_role == 'order_manager' %}
        <span class="text-xs sm:text-sm px-2 sm:px-3 py-1 bg-[#b16cff]/20 text-[#b16cff] rounded-full border border-[#b16cff]/30">‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
        {% else %}
        <span class="text-xs sm:text-sm px-2 sm:px-3 py-1 bg-[#4a9d6f]/20 text-[#4a9d6f] rounded-full border border-[#4a9d6f]/30">‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</span>
        {% endif %}
    </div>

    <!-- ‡πÄ‡∏°‡∏ô‡∏π‡∏Ç‡∏ß‡∏≤: ‡πÉ‡∏´‡πâ‡∏ö‡∏µ‡∏ö‡∏•‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏ô‡∏à‡∏≠‡πÄ‡∏•‡πá‡∏Å -->
    <div class="flex items-center gap-2 sm:gap-4 order-2 md:order-3 w-full md:w-auto justify-end">
        {% if not user.is_staff %}
        <a href="{% url 'profile' %}" class="text-white p-2 rounded-lg hover:bg-[#3a3d5c] transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" />
            </svg>
        </a>
        {% endif %}
        {% if user.is_staff and user.staff_role == 'cashier' %}
        <a href="{% url 'ai_disable_action' %}" class="px-4 sm:px-6 py-2 bg-cyan-600 hover:bg-cyan-700 text-white font-bold rounded-lg transition text-xs sm:text-sm">
            ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
        </a>
        {% elif user.is_staff and user.staff_role == 'order_manager' %}
        <a href="{% url 'order_management' %}" class="px-3 sm:px-4 py-2 bg-[#7c3aed] hover:bg-[#6d28d9] text-white font-bold rounded-lg transition text-xs sm:text-sm">
            ‡∏Ñ‡∏¥‡∏ß‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå
        </a>
        {% endif %}
        <form method="post" action="{% url 'logout' %}">
            {% csrf_token %}
            <button type="submit" class="px-4 sm:px-5 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition text-xs sm:text-sm">
                ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </form>
    </div>
</nav>

<!-- ‡πÄ‡∏°‡∏ô‡∏π admin ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (‡πÄ‡∏â‡∏û‡∏≤‡∏∞ admin ‡∏ó‡∏µ‡πà‡∏°‡∏µ is_superuser) -->
{% if user.is_superuser %}
<div class="bg-[#23243a] px-4 sm:px-6 lg:px-8 py-2 flex items-center gap-4 text-xs sm:text-sm border-b border-[#393a5a] overflow-x-auto custom-scrollbar">
    <a href="{% url 'home' %}" class="text-gray-300 hover:text-white font-medium transition whitespace-nowrap">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</a>
    <a href="{% url 'overviews' %}" class="text-gray-300 hover:text-white font-medium transition whitespace-nowrap">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</a>
    <a href="{% url 'product_manage' %}" class="text-gray-300 hover:text-white font-medium transition whitespace-nowrap">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</a>
    <a href="{% url 'ai_settings' %}" class="text-gray-300 hover:text-white font-medium transition whitespace-nowrap">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏≠‡πÑ‡∏≠</a>
</div>
{% endif %}
{% endblock navbar %}


{% block content %}
<div class="min-h-[calc(100vh-70px)] lg:h-[calc(100vh-70px)] overflow-y-auto lg:overflow-hidden grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 lg:grid-rows-5 gap-4 lg:gap-6 p-3 sm:p-4 lg:p-6 font-kanit text-white">

    <!-- ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="lg:row-span-2 bg-[#2d2d4a] rounded-lg border border-[#393a5a] p-3 flex flex-col gap-2 overflow-hidden h-full order-2 md:order-2 xl:order-1">
        <h2 class="text-base font-bold text-[#b16cff] mb-1 flex-shrink-0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
        <div class="flex-1 overflow-y-auto min-h-0 space-y-2 pr-1 custom-scrollbar">
            {% if featured_items %}
                {% for item in featured_items %}
                <div class="w-full bg-[#3a3d5c] text-white py-2 px-3 rounded-lg transition border border-[#b16cff]/20 hover:border-[#b16cff]/40 flex gap-2 items-start group flex-shrink-0">
                    <div class="w-12 h-12 bg-gradient-to-br from-[#b16cff]/30 to-[#7c3aed]/30 rounded-lg flex items-center justify-center flex-shrink-0 overflow-hidden">
                        {% if item.image %}
                        <img src="{{ item.image.url }}" alt="{{ item.name }}" class="w-full h-full object-cover">
                        {% elif item.image_url %}
                        <img src="{{ item.image_url }}" alt="{{ item.name }}" class="w-full h-full object-cover">
                        {% else %}
                        <span class="text-lg">‚≠ê</span>
                        {% endif %}
                    </div>
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <p class="font-semibold text-white truncate text-xs">{{ item.name }}</p>
                        <p class="text-[#b16cff] font-bold text-xs">‡∏ø{{ item.price }}</p>
                    </div>
                    <button class="add-to-cart-btn bg-[#b16cff] hover:bg-[#7c3aed] text-white font-semibold py-1 px-2 rounded transition text-xs flex-shrink-0 whitespace-nowrap" 
                            data-product-id="{{ item.id }}" 
                            data-product-name="{{ item.name }}" 
                            data-product-price="{{ item.price }}">
                        ‡πÄ‡∏û‡∏¥‡πà‡∏°
                    </button>
                </div>
                {% endfor %}
            {% else %}
                <p class="text-[#8b8ba8] text-xs text-center py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</p>
            {% endif %}
        </div>
    </div>

    <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î -->
    <div class="md:col-span-2 xl:col-span-2 lg:row-span-2 bg-[#2d2d4a] rounded-lg border border-[#393a5a] flex flex-col overflow-hidden p-3 h-full order-1 md:order-1 xl:order-2">
        <div class="grid grid-cols-2 gap-3 h-full">
            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏ã‡πâ‡∏≤‡∏¢: ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
            <div class="flex flex-col overflow-hidden border border-[#393a5a] rounded-lg p-2 bg-[#23243a]">
                <h2 class="text-sm font-bold text-[#b16cff] mb-2 flex-shrink-0">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h2>
                
                <!-- Search input -->
                <input 
                    type="text" 
                    id="product-search" 
                    placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." 
                    class="w-full bg-[#3a3d5c] text-white border border-[#b16cff]/20 rounded-lg px-2 py-1 mb-2 focus:outline-none focus:border-[#b16cff] transition text-xs flex-shrink-0"
                >
                
                <div class="flex gap-2 mb-2 pb-2 border-b border-[#393a5a] overflow-x-auto flex-shrink-0 custom-scrollbar">
                    <button class="category-btn category-all px-2 py-1 bg-[#b16cff] text-white rounded-lg text-xs font-semibold flex-shrink-0 transition" data-category="all">
                        ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                    {% for category in categories %}
                    <button class="category-btn px-2 py-1 bg-[#3a3d5c] text-[#8b8ba8] rounded-lg text-xs font-semibold hover:bg-[#4a4d6c] flex-shrink-0 transition" data-category="{{ category.id }}">
                        {{ category.name }}
                    </button>
                    {% endfor %}
                </div>
                
                <div class="flex-1 overflow-y-auto min-h-0 pr-1 space-y-1 custom-scrollbar">
                    {% for product in products %}
                    <div class="product-card bg-[#3a3d5c] rounded-lg p-1.5 border border-[#b16cff]/30 hover:border-[#b16cff] transition flex gap-2 items-center" data-product-name="{{ product.name }}" data-category-id="{% if product.category %}{{ product.category.id }}{% else %}none{% endif %}">
                        
                        <div class="w-14 h-14 bg-gradient-to-br from-[#b16cff]/30 to-[#7c3aed]/30 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0">
                            {% if product.image %}
                            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                            {% elif product.image_url %}
                            <img src="{{ product.image_url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                            {% else %}
                            <span class="text-xl"></span> 
                            {% endif %}
                        </div>
                        
                        <div class="flex-1 flex flex-col justify-between min-w-0">
                            <div>
                                <p class="font-semibold text-white text-xs truncate">{{ product.name }}</p>
                                <p class="text-[#b16cff] font-bold text-xs">‡∏ø{{ product.price }}</p>
                            </div>
                            <button class="add-to-cart-btn w-full bg-[#b16cff] hover:bg-[#7c3aed] text-white font-semibold py-0.5 rounded transition text-xs" 
                                    data-product-id="{{ product.id }}" 
                                    data-product-name="{{ product.name }}" 
                                    data-product-price="{{ product.price }}">
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                    {% empty %}
                    <p class="text-[#8b8ba8] text-center text-xs py-2">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
                    {% endfor %}
                </div>
            </div>

            <!-- ‡∏ù‡∏±‡πà‡∏á‡∏Ç‡∏ß‡∏≤: ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô -->
            <div class="flex flex-col overflow-hidden border border-[#393a5a] rounded-lg p-2 bg-[#23243a]">
                <h2 class="text-sm font-bold text-[#b16cff] mb-2 flex-shrink-0">‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</h2>
                
                <div class="flex-1 overflow-y-auto min-h-0 pr-1 space-y-2 custom-scrollbar">
                    {% if promotions %}
                        {% for promo in promotions %}
                        <div class="bg-[#3a3d5c] rounded-lg overflow-hidden border border-[#b16cff]/20 flex flex-col flex-shrink-0">
                            <div class="w-full aspect-video bg-gradient-to-br from-[#b16cff]/30 to-[#7c3aed]/30 flex items-center justify-center overflow-hidden">
                                {% if promo.image %}
                                <img src="{{ promo.image.url }}" alt="{{ promo.title }}" class="w-full h-full object-cover">
                                {% elif promo.image_url %}
                                <img src="{{ promo.image_url }}" alt="{{ promo.title }}" class="w-full h-full object-cover">
                                {% else %}
                                <span class="text-3xl">üì¢</span>
                                {% endif %}
                            </div>
                            <div class="p-2 flex flex-col justify-between flex-1">
                                <div>
                                    <p class="font-semibold text-white text-xs line-clamp-1">{{ promo.title }}</p>
                                    {% if promo.description %}
                                    <p class="text-[#8b8ba8] text-xs line-clamp-1 mt-1">{{ promo.description }}</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                    <div class="flex items-center justify-center h-full">
                        <p class="text-[#8b8ba8] text-center text-xs">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÇ‡∏õ‡∏£‡πÇ‡∏°‡∏ä‡∏±‡πà‡∏ô</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- ‡πÅ‡∏ä‡∏ó -->
    <div class="lg:row-span-3 bg-[#2d2d4a] rounded-lg border border-[#393a5a] flex flex-col overflow-hidden p-3 h-full order-5 xl:order-3">
        <div class="flex items-center justify-between mb-2 flex-shrink-0">
            <h2 class="text-base font-bold text-[#b16cff]">‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢</h2>
            <button id="clear-chat-btn" class="text-xs bg-[#393a5a] hover:bg-red-600/30 text-[#8b8ba8] hover:text-red-400 px-2 py-1 rounded transition" title="‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤">
                ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤
            </button>
        </div>
        <div class="flex-1 overflow-y-auto min-h-0 mb-2 bg-[#1a1a2e] rounded p-2 custom-scrollbar">
            <div id="chat-messages" class="space-y-2 flex flex-col">
                <div class="text-[#8b8ba8] text-center text-xs py-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</div>
            </div>
        </div>
        <div class="flex gap-1 flex-shrink-0">
            <input type="text" id="chat-input" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°..." class="flex-1 bg-[#3a3d5c] text-white border border-[#b16cff]/20 rounded px-2 py-1.5 text-xs focus:outline-none focus:border-[#b16cff]">
            <button id="chat-send-btn" class="bg-[#b16cff] hover:bg-[#7c3aed] text-white font-semibold px-3 py-1.5 rounded transition text-xs">
                ‡∏™‡πà‡∏á
            </button>
        </div>
    </div>

    <!-- ‡∏õ‡∏∏‡πà‡∏° AI Order + Call Staff -->
    <div class="lg:row-span-5 flex flex-col items-center justify-center gap-2 h-full order-3 md:order-3 xl:order-4">
        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÅ‡∏Ñ‡∏ä‡πÄ‡∏ä‡∏µ‡∏¢‡∏£‡πå‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
        {% if user.is_staff and user.staff_role == 'cashier' %}
        <button id="call-staff-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold rounded-full w-32 h-32 sm:w-40 sm:h-40 text-lg sm:text-xl flex items-center justify-center text-center shadow-lg transform transition hover:scale-105 duration-300 mb-4">
            <span>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>
        </button>
        {% endif %}
        
        <button id="ai-order-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold rounded-full w-48 h-48 sm:w-56 sm:h-56 lg:w-72 lg:h-72 xl:w-80 xl:h-80 text-lg sm:text-2xl flex items-center justify-center text-center shadow-lg transform transition hover:scale-105 duration-300">
            <span id="ai-btn-text">‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</span>
        </button>
        <p class="text-white text-xs sm:text-sm font-semibold text-center">‡πÅ‡∏ï‡∏∞‡∏õ‡∏∏‡πà‡∏° ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ</p>
        <p class="text-green-300 text-xs sm:text-sm font-semibold text-center">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡πÄ‡∏û‡∏¥‡πà‡∏°","‡∏ã‡∏∑‡πâ‡∏≠"</p>
        <p class="text-red-300 text-xs sm:text-sm font-semibold text-center">‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ‡∏´‡∏£‡∏∑‡∏≠ ‡∏î‡∏≤‡∏ß</p>
        <p class="text-red-600 text-xs sm:text-sm font-semibold text-center">‡∏•‡∏ö ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏•‡∏ö" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î"‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
    </div>

    <!-- ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ -->
    <div class="lg:row-span-3 bg-[#2d2d4a] border border-[#393a5a] p-2 flex flex-col rounded-lg overflow-hidden h-full order-4 xl:order-5">
        <div class="mb-2 flex-shrink-0">
            <h2 class="text-[#b16cff] font-bold text-base mb-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</h2>
            <div class="bg-[#3a3d5c] rounded-lg p-2 border border-[#b16cff]/20">
                <p class="text-[#8b8ba8] text-xs">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                <p class="text-white text-lg font-bold"><span id="cart-count">0</span> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto mb-2 min-h-0 custom-scrollbar">
            <div id="cart-items" class="space-y-1">
                <p class="text-[#8b8ba8] text-center text-xs py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
            </div>
        </div>
        <div class="border-t border-[#393a5a] mb-2 flex-shrink-0"></div>
        <div class="mb-2 flex-shrink-0">
            <div class="flex justify-between">
                <span class="text-[#8b8ba8] text-xs">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô:</span>
                <span class="text-white font-bold text-sm">‡∏ø<span id="total-price">0.00</span></span>
            </div>
        </div>
        <div class="space-y-1 flex-shrink-0">
            <button id="test-add-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-1 rounded-lg transition border border-[#b16cff]/20 text-xs" style="display: none;">
                ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
            </button>
            <button id="clear-cart-btn" class="w-full bg-[#3a3d5c] hover:bg-[#4a4d6c] text-white font-semibold py-1 rounded-lg transition border border-[#b16cff]/20 text-xs">
                ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
            <button id="payment-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-1.5 rounded-lg transition text-sm" onclick="handlePaymentClick(event)">
                ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô
            </button>
        </div>
    </div>

</div>

<div id="closeAiModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-50 p-4">
    <div class="bg-[#3a3d5c] rounded-lg p-4 max-w-md w-full border border-[#b16cff]/20">
        <h3 class="text-[#b16cff] font-bold text-base mb-3">‡∏õ‡∏¥‡∏î AI Cashier</h3>
        <p class="text-[#8b8ba8] mb-3 text-sm">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
        
        <form method="post" action="{% url 'close_ai' %}" class="space-y-3">
            {% csrf_token %}
            <div>
                <label class="text-[#b16cff] text-xs font-semibold">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
                <input type="text" name="username" class="w-full bg-[#23243a] text-white border border-[#b16cff]/20 rounded px-3 py-2 mt-1 focus:outline-none focus:border-[#b16cff] text-sm" required>
            </div>
            <div>
                <label class="text-[#b16cff] text-xs font-semibold">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
                <input type="password" name="password" class="w-full bg-[#23243a] text-white border border-[#b16cff]/20 rounded px-3 py-2 mt-1 focus:outline-none focus:border-[#b16cff] text-sm" required>
            </div>
            <div class="flex gap-2">
                <button type="button" id="cancel-close-ai" class="flex-1 bg-[#3a3d5c] hover:bg-[#4a4d6c] text-white font-semibold py-1.5 rounded transition text-xs">
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
                <button type="submit" class="flex-1 bg-red-600 hover:bg-red-700 text-white font-semibold py-1.5 rounded transition text-xs">
                    ‡∏õ‡∏¥‡∏î AI
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    /* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á Scrollbar ‡πÉ‡∏´‡πâ‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏£‡∏Å */
    .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
        height: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-track {
        background: #2d2d4a; 
    }
    .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #5b5d7e; 
        border-radius: 4px;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
        background: #b16cff; 
    }
</style>

<script>
    // ### ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏∏‡πà‡∏° AI Voice Order ###
    const aiBtn = document.getElementById('ai-order-btn');
    const aiBtnText = document.getElementById('ai-btn-text');
    let isListening = false;
    let recognition = null;
    
    // ### Conversation History (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö voice ‡πÅ‡∏•‡∏∞ chat) ###
    let conversationHistory = [];
    try {
        const saved = localStorage.getItem('chatHistory');
        if (saved) {
            conversationHistory = JSON.parse(saved);
            console.log('[CHAT]  Loaded history from storage:', conversationHistory.length, 'messages');
        }
    } catch (e) {
        console.warn('[CHAT]  Failed to load history from storage:', e);
        conversationHistory = [];
    }

    function saveChatHistory() {
        try {
            localStorage.setItem('chatHistory', JSON.stringify(conversationHistory));
            console.log('[CHAT]  Saved history to storage');
        } catch (e) {
            console.warn('[CHAT]  Failed to save history:', e);
        }
    }
    
    // Initialize Web Speech API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    
    // Initialize recognition with error handling
    function initializeRecognition() {
        if (!SpeechRecognition) {
            console.error('[VOICE] SpeechRecognition not supported');
            return null;
        }
        
        try {
            const rec = new SpeechRecognition();
            rec.lang = 'th-TH'; // Thai language
            rec.continuous = false;
            rec.interimResults = true; // ‡πÄ‡∏õ‡∏¥‡∏î interim results ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏£
            rec.maxAlternatives = 3; // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å 1 ‡πÄ‡∏õ‡πá‡∏ô 3 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß
            
            console.log('[VOICE] ‚úì Recognition initialized');
            
            //  ‡∏Å‡∏≥‡∏´‡∏ô‡∏î event handlers ‡πÄ‡∏°‡∏∑‡πà‡∏≠ recognition ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            rec.onstart = () => {
                console.log('[VOICE] Recording started');
                isListening = true;
                // Set timeout to auto-stop after 10 seconds
                clearTimeout(window.voiceTimeout);
                window.voiceTimeout = setTimeout(() => {
                    console.log('[VOICE]  Auto-stopping after timeout');
                    if (isListening && recognition) {
                        recognition.stop();
                    }
                }, 10000); // 10 seconds
            };
            
            rec.onresult = function(event) {
                console.log('[VOICE]  Result event, results count:', event.results.length);
                let transcript = '';
                let interimTranscript = '';
                let bestResult = null;
                let bestConfidence = 0;
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const text = result[0].transcript;
                    const confidence = result[0].confidence * 100;
                    
                    if (result.isFinal) {
                        console.log(`[VOICE]  FINAL Result ${i}: "${text}" (confidence: ${confidence.toFixed(2)}%)`);
                        transcript += text + ' ';
                        
                        // ‡πÄ‡∏Å‡πá‡∏ö final result ‡∏ó‡∏µ‡πà‡∏°‡∏µ confidence ‡∏™‡∏π‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
                        if (confidence > bestConfidence) {
                            bestConfidence = confidence;
                            bestResult = text;
                        }
                    } else {
                        console.log(`[VOICE]  interim Result ${i}: "${text}" (confidence: ${confidence.toFixed(2)}%)`);
                        interimTranscript += text + ' ';
                    }
                }
                
                transcript = transcript.trim();
                
                if (transcript) {
                    console.log('[VOICE] ‚úì Final transcript:', transcript, '(best confidence:', bestConfidence.toFixed(2) + '%)');
                    // ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡πÑ‡∏õ API
                    sendVoiceMessage(transcript);
                } else if (interimTranscript) {
                    console.log('[VOICE]  Only interim results (might still record more):', interimTranscript);
                } else {
                    console.warn('[VOICE]  No results captured');
                }
            };
            
            rec.onerror = function(event) {
                console.error('[VOICE]  Speech recognition error:', event.error);
                isListening = false;
                aiBtnText.innerHTML = '‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
                aiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                aiBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                aiBtn.disabled = false;
                
                let errorMessage = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ';
                switch(event.error) {
                    case 'network':
                        errorMessage += '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï';
                        break;
                    case 'no-speech':
                        errorMessage += '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏û‡∏π‡∏î‡πÉ‡∏´‡πâ‡∏ä‡∏±‡∏î ‡πÅ‡∏•‡∏∞‡πÉ‡∏à‡πÄ‡∏¢‡πá‡∏ô‡πÜ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà)';
                        break;
                    case 'not-allowed':
                        errorMessage += '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå)';
                        break;
                    case 'audio-capture':
                        errorMessage += '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏°‡πÇ‡∏Ñ‡∏£‡πÇ‡∏ü‡∏ô)';
                        break;
                    case 'aborted':
                        errorMessage += '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ';
                        break;
                    default:
                        errorMessage += event.error;
                }
                console.error('[VOICE] Error details:', errorMessage);
            };
            
            rec.onend = function() {
                console.log('[VOICE]  Recording ended');
                isListening = false;
                clearTimeout(window.voiceTimeout); // ‡∏•‡πâ‡∏≤‡∏á timeout
                aiBtnText.innerHTML = '‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
                aiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                aiBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                aiBtn.disabled = false;
            };
            
            return rec;
        } catch (e) {
            console.error('[VOICE]  Error initializing recognition:', e);
            return null;
        }
    }
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á recognition object
    recognition = initializeRecognition();
    
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á (Voices) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏£‡πâ‡∏≠‡∏°
    if ('speechSynthesis' in window) {
        // ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° ‡πÇ‡∏´‡∏•‡∏î voices
        let voicesLoadAttempts = 0;
        
        function loadVoices() {
            const voices = window.speechSynthesis.getVoices();
            if (voices.length > 0) {
                console.log('[TTS] Voices loaded:', voices.length);
                // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á Thai ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
                const thaiVoices = voices.filter(v => v.lang.includes('th'));
                if (thaiVoices.length > 0) {
                    console.log('[TTS] Found Thai voice:', thaiVoices[0].name);
                } else {
                    console.log('[TTS] No Thai voice found, will use default');
                }
            } else if (voicesLoadAttempts < 3) {
                voicesLoadAttempts++;
                console.log('[TTS] Retrying voices load...');
                setTimeout(loadVoices, 500);
            }
        }
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å loadVoices ‡πÄ‡∏°‡∏∑‡πà‡∏≠ voices ‡∏û‡∏£‡πâ‡∏≠‡∏°
        if (window.speechSynthesis.onvoiceschanged !== undefined) {
            window.speechSynthesis.onvoiceschanged = loadVoices;
        }
        loadVoices(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å once ‡πÄ‡∏•‡∏¢
    }

    //  Click handler ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°
    aiBtn.addEventListener('click', function() {
        if (!recognition) {
            alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á');
            console.error('[VOICE] Recognition is null');
            return;
        }
        
        if (!isListening) {
            try {
                console.log('[VOICE]  Starting recording...');
                isListening = true;
                aiBtnText.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏±‡∏ö‡∏ü‡∏±‡∏á...'; 
                aiBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
                aiBtn.classList.add('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                aiBtn.disabled = true;
                
                // Reset recognition state
                try {
                    recognition.abort();
                } catch (e) {
                    console.log('[VOICE] (abort not needed)');
                }
                
                // ‡πÄ‡∏£‡∏∑‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                recognition.start();
                console.log('[VOICE] ‚úì Recording started');
            } catch (e) {
                console.error('[VOICE]  Error starting recognition:', e);
                isListening = false;
                aiBtnText.innerHTML = '‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
                aiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                aiBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                aiBtn.disabled = false;
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ: ' + e.message);
            }
        } else {
            try {
                console.log('[VOICE]  Stopping recording...');
                recognition.stop();
                console.log('[VOICE]  Stop command sent');
            } catch (e) {
                console.error('[VOICE]  Error stopping recognition:', e);
                isListening = false;
                aiBtnText.innerHTML = '‡∏™‡∏±‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤<br>‡∏Å‡∏±‡∏ö‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏Ç‡∏≤‡∏¢';
                aiBtn.classList.add('bg-red-600', 'hover:bg-red-700');
                aiBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700', 'animate-pulse');
                aiBtn.disabled = false;
            }
        }
    });
    
    // === CALL STAFF BUTTON ===
    const callStaffBtn = document.getElementById('call-staff-btn');
    if (callStaffBtn) {
        callStaffBtn.addEventListener('click', async function() {
            try {
                console.log('[STAFF] Calling staff...');
                callStaffBtn.disabled = true;
                const originalHTML = callStaffBtn.innerHTML;
                callStaffBtn.innerHTML = '<span>‚è≥<br>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏Å...</span>';
                
                const response = await fetch('{% url "api_call_staff" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        reason: '‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    console.log('[STAFF] ‚úì Staff called');
                    callStaffBtn.innerHTML = '<span>‚úì<br>‡∏™‡πà‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏•‡πâ‡∏ß!</span>';
                    callStaffBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                    callStaffBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    
                    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                    setTimeout(() => {
                        callStaffBtn.disabled = false;
                        callStaffBtn.innerHTML = originalHTML;
                        callStaffBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                        callStaffBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                    }, 3000);
                } else {
                    alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ: ' + data.message);
                    callStaffBtn.disabled = false;
                    callStaffBtn.innerHTML = originalHTML;
                }
            } catch (error) {
                console.error('[STAFF] Error:', error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
                callStaffBtn.disabled = false;
                callStaffBtn.innerHTML = '<span>üîî<br>‡πÄ‡∏£‡∏µ‡∏¢‡∏Å<br>‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô</span>';
            }
        });
    }
    
    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ API
    function sendVoiceMessage(userMessage) {
        console.log('[VOICE]  Sending message to API:', userMessage);
        console.log('[VOICE]  With conversation history:', conversationHistory.length, 'messages');
        aiBtn.disabled = true;
        
        fetch('/api/voice-order/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ 
                user_message: userMessage,
                conversation_history: conversationHistory.slice(0, -1)  // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            }),
            credentials: 'same-origin'
        })
        .then(response => {
            console.log('[VOICE] ‚úì Response received, status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('[VOICE]  API Response:', data);
            if (data.success) {
                console.log('[VOICE] ‚úì AI Response:', data.message);
                
                // ‡∏ñ‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                if (data.cart && data.cart.success) {
                    console.log('[VOICE] Cart updated successfully:', data.cart.message);
                    console.log('[VOICE]  Reloading cart...');
                    loadCart();
                } else if (data.cart) {
                    console.log('[VOICE]  Cart response:', data.cart.message);
                    // ‡∏ñ‡∏∂‡∏á‡πÅ‡∏°‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Å‡πá‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                    loadCart();
                } else {
                    console.log('[VOICE]  No cart action');
                }
                
                // ‡∏û‡∏π‡∏î‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö
                console.log('[VOICE]  Speaking response...');
                speakResponse(data.message);
                
                // ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ô‡πÅ‡∏ä‡∏ó
                addChatMessage(userMessage, true);
                addChatMessage(data.message, false);
            } else {
                console.error('[VOICE]  API Error:', data.error);
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'));
            }
        })
        .catch(error => {
            console.error('[VOICE]  Fetch error:', error);
            alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ');
        })
        .finally(() => {
            console.log('[VOICE] ‚úì sendVoiceMessage complete, enabling button');
            aiBtn.disabled = false;
        });
    }
    function cleanAiText(text) {
        if (!text) return '';

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà * ‡∏Å‡∏±‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô "***", "**", "  ***  ") ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
        if (/^[\s*]+$/.test(text)) {
            return '';
        }

    // ‡πÄ‡∏≠‡∏≤ asterisks ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏Å (‡∏´‡πâ‡∏≤‡∏°‡∏°‡∏µ * ‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î)
        let cleaned = text.replace(/\*+/g, '');

    // ‡∏ï‡∏±‡∏î‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢
        cleaned = cleaned.trim();

        return cleaned;
}
    // ‡πÉ‡∏ä‡πâ Web Speech API ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏û‡∏π‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (TTS) - with retry logic
    function speakResponse(text) {
        // ‡∏ñ‡πâ‡∏≤ browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö TTS
        if (!('speechSynthesis' in window)) {
            console.warn('[TTS]  Text-to-speech not supported in this browser');
            console.log('[TTS] Text to display:', text);
            return;
        }
    
        // --- üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏û‡∏π‡∏î ---
        if (text === null || text === undefined) {
            text = '';
        }
    
        // ‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô string ‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå‡∏î‡∏≠‡∏Å‡∏à‡∏±‡∏ô‡∏≠‡∏≠‡∏Å
        let cleaned = String(text)
            // ‡∏ï‡∏±‡∏î‡∏û‡∏ß‡∏Å "***", "*****", "**" ‡∏≠‡∏≠‡∏Å
            .replace(/\*{2,}/g, ' ')
            // ‡∏¢‡∏∏‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
            .replace(/\s+/g, ' ')
            .trim();
    
        // ‡∏ñ‡πâ‡∏≤‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏î‡∏¥‡∏°‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà "***") ‚Üí ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏π‡∏î
        if (!cleaned) {
            console.log('[TTS]  Skip star-only / empty text:', JSON.stringify(text));
            return;
        }
    
        try {
            // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏û‡∏π‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
            if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                console.log('[TTS]  Cancelling previous speech');
                window.speechSynthesis.cancel();
            }
        
            const utterance = new SpeechSynthesisUtterance(cleaned);            
            // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
            utterance.lang = 'th-TH'; // Thai language
            utterance.rate = 1.1; // ‡πÄ‡∏£‡πá‡∏ß‡∏Å‡∏ß‡πà‡∏≤ (‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥)
            utterance.pitch = 0.8; // ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢
            utterance.volume = 1.0;
            
            // ‡∏•‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á Thai ‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢ ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
            try {
                const voices = window.speechSynthesis.getVoices();
                console.log('[TTS] Available voices:', voices.length);
                
                if (voices.length > 0) {
                    // ‡∏•‡∏≠‡∏á‡∏´‡∏≤‡πÄ‡∏™‡∏µ‡∏¢‡∏á Thai ‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô
                    let thaiVoice = voices.find(v => v.lang && (v.lang === 'th-TH' || v.lang === 'th' || v.lang.startsWith('th')) && !v.name.includes('Female'));
                    
                    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á Thai ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡∏´‡∏≤ Google Thai male
                    if (!thaiVoice) {
                        thaiVoice = voices.find(v => v.name && v.name.includes('Thai') && !v.name.includes('Female'));
                    }
                    
                    // ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á Thai ‡∏ï‡∏±‡∏ß‡πÉ‡∏î‡∏Å‡πá‡πÑ‡∏î‡πâ
                    if (!thaiVoice) {
                        thaiVoice = voices.find(v => v.lang && (v.lang === 'th-TH' || v.lang === 'th' || v.lang.startsWith('th')));
                    }
                    
                    // Fallback: ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á default ‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤
                    if (!thaiVoice && voices.length > 0) {
                        // ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏£‡∏Å ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà English
                        thaiVoice = voices.find(v => v.lang && !v.lang.startsWith('en')) || voices[0];
                    }
                    
                    if (thaiVoice) {
                        utterance.voice = thaiVoice;
                        console.log('[TTS]  Using male voice:', thaiVoice.name, '(' + (thaiVoice.lang || 'unknown') + ')');
                    } else {
                        console.warn('[TTS]  No Thai voice found, using system default');
                    }
                } else {
                    console.warn('[TTS]  No voices available yet (will use default)');
                }
            } catch (e) {
                console.warn('[TTS]  Error selecting voice:', e);
            }
            
            // Event handlers
            utterance.onstart = () => {
                console.log('[TTS] Speaking started');
            };
            
            utterance.onend = () => {
                console.log('[TTS] Speaking ended');
            };
            
            utterance.onpause = () => {
                console.log('[TTS] Speaking paused');
            };
            
            utterance.onresume = () => {
                console.log('[TTS] Speaking resumed');
            };
            
            utterance.onerror = (event) => {
                console.error('[TTS]  Speech synthesis error:', event.error);
                // Retry with default settings
                if (event.error !== 'network' && event.error !== 'synthesis-unavailable') {
                    console.log('[TTS] Retrying with default voice...');
                    const retryUtterance = new SpeechSynthesisUtterance(text);
                    retryUtterance.rate = 1.2;
                    retryUtterance.pitch = 0.8;
                    try {
                        window.speechSynthesis.speak(retryUtterance);
                    } catch (e) {
                        console.error('[TTS] Retry failed:', e);
                    }
                }
            };
            
            // ‡∏û‡∏π‡∏î
            console.log('[TTS] Starting speech synthesis (male voice, rate 1.2)...');
            window.speechSynthesis.speak(utterance);
            
        } catch (e) {
            console.error('[TTS] Fatal error in speakResponse:', e);
        }
    }

    // ### ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ###
    // ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏à‡∏≤‡∏Å server
    function loadCart() {
        console.log('[CART] loadCart() called');
        const headers = {
            'Content-Type': 'application/json'
        };
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        fetch('/api/cart/', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ action: 'get' }),
            credentials: 'same-origin'  // ‡∏™‡πà‡∏á cookies ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        })
        .then(response => {
            console.log('[CART] Response status:', response.status);
            if (!response.ok) {
                console.error('[CART] HTTP error:', response.status);
                throw new Error('HTTP ' + response.status);
            }
            return response.json();
        })
        .then(data => {
            console.log('[CART] Response data:', data);
            if (data.success) {
                console.log('[CART] Success! Cart items:', data.cart);
                updateCartDisplay(data.cart, data.total || 0);
            } else {
                console.error('[CART]  API error:', data.error);
            }
        })
        .catch(error => {
            console.error('[CART]  Fetch error:', error);
            console.error('[CART] Stack:', error.stack);
        });
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function updateCartDisplay(cartItems, total) {
        console.log('[CART] updateCartDisplay START');
        
        const cartItemsDiv = document.getElementById('cart-items');
        const cartCountSpan = document.getElementById('cart-count');
        const totalPriceSpan = document.getElementById('total-price');

        if (!cartItemsDiv || !cartCountSpan || !totalPriceSpan) {
            console.error('[CART] ERROR: Elements not found!');
            return;
        }

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        try {
            cartCountSpan.textContent = cartItems.length;
        } catch (e) {
            console.error('[CART] Error updating count:', e);
        }

        try {
            totalPriceSpan.textContent = total.toFixed(2);
        } catch (e) {
            console.error('[CART] Error updating total:', e);
        }

        // ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πà‡∏≤
        try {
            cartItemsDiv.innerHTML = '';
        } catch (e) {
            console.error('[CART] Error clearing:', e);
        }

        if (cartItems.length === 0) {
            try {
                cartItemsDiv.innerHTML = '<p class="text-[#8b8ba8] text-center text-xs py-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
            } catch (e) {
                console.error('[CART] Error setting empty message:', e);
            }
            return;
        }

        // ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
        cartItems.forEach((item, idx) => {
            try {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-[#393a5a] p-1.5 rounded-lg border border-[#b16cff]/10 flex justify-between items-center text-xs';
                itemDiv.innerHTML = `
                    <div class="flex-1 min-w-0">
                        <p class="text-white font-semibold truncate">${item.product_name}</p>
                        <p class="text-[#8b8ba8] text-xs">${item.quantity}x ‡∏ø${item.price.toFixed(2)}</p>
                    </div>
                    <div class="ml-1 flex items-center gap-1">
                        <span class="text-white font-bold whitespace-nowrap">‡∏ø${(item.price * item.quantity).toFixed(2)}</span>
                        <button class="decrease-btn bg-[#3a3d5c] hover:bg-[#5b5d7e] text-white px-1.5 rounded transition" data-product-id="${item.product_id}">‚àí</button>
                        <span class="text-white font-semibold min-w-[24px] text-center">${item.quantity}</span>
                        <button class="increase-btn bg-[#b16cff] hover:bg-[#7c3aed] text-white px-1.5 rounded transition" data-product-id="${item.product_id}">+</button>
                        <button class="remove-btn bg-red-600/20 hover:bg-red-600/40 text-red-400 px-1 rounded transition" data-product-id="${item.product_id}">‚úï</button>
                    </div>
                `;
                cartItemsDiv.appendChild(itemDiv);

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö
                itemDiv.querySelector('.remove-btn').addEventListener('click', function() {
                    removeFromCart(item.product_id);
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                itemDiv.querySelector('.increase-btn').addEventListener('click', function() {
                    updateCartQuantity(item.product_id, item.quantity + 1);
                });

                // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô
                itemDiv.querySelector('.decrease-btn').addEventListener('click', function() {
                    if (item.quantity > 1) {
                        updateCartQuantity(item.product_id, item.quantity - 1);
                    } else {
                        removeFromCart(item.product_id);
                    }
                });
            } catch (e) {
                console.error(`[CART] Error rendering item ${idx + 1}:`, e);
            }
        });
    }

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function addToCart(productId, productName, price, quantity = 1) {
        console.log(`[CART] addToCart called: ${productName} (ID:${productId}) x${quantity}`);
        const headers = {
            'Content-Type': 'application/json'
        };
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        } else {
            console.warn('[CART]  No CSRF token found!');
        }
        
        console.log('[CART] Sending request to /api/cart/', {
            action: 'add',
            product_id: productId,
            quantity: quantity
        });
        
        fetch('/api/cart/', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ 
                action: 'add',
                product_id: productId,
                quantity: quantity
            }),
            credentials: 'same-origin'  // ‡∏™‡πà‡∏á cookies ‡πÑ‡∏õ‡∏î‡πâ‡∏ß‡∏¢
        })
        .then(response => {
            console.log('[CART] Response status:', response.status);
            console.log('[CART] Response headers:', response.headers);
            return response.json().catch(err => {
                console.error('[CART] Failed to parse JSON:', err);
                return null;
            });
        })
        .then(data => {
            if (!data) {
                console.error('[CART] ‚ùå Response was not valid JSON');
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            
            console.log('[CART] Response data:', data);
            
            if (data.success) {
                console.log('[CART] ‚úì Added successfully, reloading cart');
                loadCart(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° success
                const msg = data.message || `‡πÄ‡∏û‡∏¥‡πà‡∏° ${productName} ‡πÅ‡∏•‡πâ‡∏ß`;
                console.log('[CART] Success message:', msg);
                // ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏™‡∏î‡∏á toast notification ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
            } else {
                console.error('[CART]  API returned error:', data.error);
                alert(`‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ: ${data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'}`);
            }
        })
        .catch(error => {
            console.error('[CART]  Fetch error:', error);
            console.error('[CART] Error stack:', error.stack);
            alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        });
    }

    // ‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function removeFromCart(productId) {
        fetch('/api/cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ 
                action: 'remove',
                product_id: productId
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadCart(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            }
        })
        .catch(error => console.error('Remove from cart error:', error));
    }

    // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    function updateCartQuantity(productId, newQuantity) {
        console.log(`[CART] updateCartQuantity: product ${productId} to quantity ${newQuantity}`);
        const headers = {
            'Content-Type': 'application/json'
        };
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        if (csrfToken) {
            headers['X-CSRFToken'] = csrfToken;
        }
        
        fetch('/api/cart/', {
            method: 'POST',
            headers: headers,
            body: JSON.stringify({ 
                action: 'update',
                product_id: productId,
                quantity: newQuantity
            }),
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log('[CART] Quantity updated successfully');
                loadCart(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
            }
        })
        .catch(error => console.error('[CART] Update quantity error:', error));
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
    document.getElementById('clear-cart-btn')?.addEventListener('click', function() {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
            fetch('/api/cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
                },
                body: JSON.stringify({ action: 'clear' }),
                credentials: 'same-origin'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadCart(); // ‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
                }
            })
            .catch(error => console.error('Clear cart error:', error));
        }
    });



    // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏à‡πÇ‡∏´‡∏•‡∏î
    document.addEventListener('DOMContentLoaded', function() {
        loadCart();
    });

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏° "add-to-cart-btn" ‡πÑ‡∏õ‡∏¢‡∏±‡∏á server cart
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('add-to-cart-btn')) {
            e.stopPropagation(); // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ propagate ‡πÑ‡∏õ‡∏¢‡∏±‡∏á element ‡πÅ‡∏°‡πà
            // ‡∏´‡∏≤‡∏õ‡∏∏‡πà‡∏° add-to-cart-btn ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏Ñ‡∏•‡∏¥‡∏Å (‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÇ‡∏î‡∏ô‡∏•‡∏π‡∏Å‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°)
            const btn = e.target.closest('.add-to-cart-btn');
            if (btn) {
                 const productId = parseInt(btn.dataset.productId);
                 const productName = btn.dataset.productName;
                 const productPrice = parseFloat(btn.dataset.productPrice);
                 addToCart(productId, productName, productPrice, 1);
            }
        }
    }, true);

    // ===== Payment Handler Function =====
    function handlePaymentClick(event) {
        event.preventDefault();
        event.stopPropagation();
        console.log('[PAYMENT] CLICKED - handlePaymentClick called');
        
        const cartCount = document.getElementById('cart-count');
        const totalPrice = document.getElementById('total-price');
        
        console.log('[PAYMENT] Cart count:', cartCount?.textContent);
        console.log('[PAYMENT] Total price:', totalPrice?.textContent);
        
        if (!cartCount || cartCount.textContent === '0') {
            alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô');
            return;
        }
        
        const totalAmount = parseFloat(totalPrice.textContent);
        if (isNaN(totalAmount) || totalAmount <= 0) {
            alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
            return;
        }
        
        console.log('[PAYMENT] Amount validated:', totalAmount);
        
        // Get CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
        console.log('[PAYMENT] CSRF token exists:', csrfToken.length > 0);
        
        console.log('[PAYMENT] Sending request to /set-payment-amount/');
        
        // Set session and redirect to payment
        fetch('/set-payment-amount/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({amount: totalAmount}),
            credentials: 'include'
        })
        .then(response => {
            console.log('[PAYMENT] Response received, status:', response.status);
            if (!response.ok) {
                console.error('[PAYMENT] HTTP error, status:', response.status);
                return response.text().then(text => {
                    console.error('[PAYMENT] Response text:', text);
                    throw new Error('HTTP ' + response.status);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('[PAYMENT] JSON parsed:', data);
            if (data.success) {
                console.log('[PAYMENT] Success! Redirecting to /payment/');
                window.location.href = '/payment/';
            } else {
                console.error('[PAYMENT] API returned error:', data.error);
                alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'));
            }
        })
        .catch(error => {
            console.error('[PAYMENT] Fetch error:', error.message);
            console.error('[PAYMENT] Stack:', error.stack);
            alert('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + error.message);
        });
    }
    
    // ### ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ Modal ###
    const modal = document.getElementById('closeAiModal');
    const closeAiBtn = document.querySelector('a[href*="ai_disable_action"]'); // ‡∏à‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏≤‡∏Å href
    const cancelBtn = document.getElementById('cancel-close-ai');
    
    function showModal(e) {
        if(e) e.preventDefault();
        modal.classList.remove('hidden');
    }
    
    function hideModal() {
        modal.classList.add('hidden');
    }
    
    if (closeAiBtn) {
        closeAiBtn.addEventListener('click', showModal);
    }

    if (cancelBtn) {
        cancelBtn.addEventListener('click', hideModal);
    }
    
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            hideModal();
        }
    });
    

    // ### ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ###
    const searchInput = document.getElementById('product-search');
    
    searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const products = document.querySelectorAll('.product-card'); 
        
        products.forEach(product => {
            const productName = product.dataset.productName.toLowerCase();
            if (productName.includes(searchTerm)) {
                product.style.display = 'flex'; 
            } else {
                product.style.display = 'none';
            }
        });
    });

    // ### ‡πÅ‡∏ä‡∏ó ###
    const chatInput = document.getElementById('chat-input');
    const chatSendBtn = document.getElementById('chat-send-btn');
    const clearChatBtn = document.getElementById('clear-chat-btn');
    const chatMessages = document.getElementById('chat-messages');
    let isSending = false;
    
    // conversationHistory ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô voice section ‡πÅ‡∏•‡πâ‡∏ß

    function addChatMessage(message, isUser = false) {
        if (chatMessages.children.length === 1 && chatMessages.children[0].textContent.includes('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô')) {
            chatMessages.innerHTML = '';
        }
    const displayText = isUser ? message : cleanAiText(message);

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≤‡∏Å AI ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô "***" ‡∏Å‡πá‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á bubble
        if (!isUser && !displayText) {
            console.log('[CHAT]  Skip displaying placeholder AI message:', JSON.stringify(message));
            return;
        }
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${isUser ? 'justify-end' : 'justify-start'}`;
        
        const msgBubble = document.createElement('div');
        msgBubble.className = `max-w-xs px-3 py-2 rounded-lg text-xs ${
            isUser 
                ? 'bg-[#b16cff] text-white rounded-br-none' 
                : 'bg-[#3a3d5c] text-white border border-[#b16cff]/30 rounded-bl-none'
        }`;
        msgBubble.textContent = displayText;
        
        msgDiv.appendChild(msgBubble);
        chatMessages.appendChild(msgDiv);
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI response ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
        // user message ‡πÑ‡∏î‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏ô event listener
        if (!isUser) {
            conversationHistory.push({
                role: 'assistant',
                content: message
            });
            saveChatHistory();  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô localStorage
        }
        
        chatMessages.parentElement.scrollTop = chatMessages.parentElement.scrollHeight;
    }

    chatSendBtn.addEventListener('click', function() {
        const message = chatInput.value.trim();
        if (message === '' || isSending) return;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏•‡∏á‡πÉ‡∏ô history ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        conversationHistory.push({
            role: 'user',
            content: message
        });
        saveChatHistory();  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÉ‡∏ô localStorage
        
        addChatMessage(message, true);  // ‡πÅ‡∏™‡∏î‡∏á‡∏ö‡∏ô UI
        chatInput.value = '';
        isSending = true;
        chatSendBtn.disabled = true;
        
        console.log('[CHAT] Sending message:', message);
        console.log('[CHAT] Current history:', conversationHistory.length, 'messages');
        console.log('[CHAT] Full history:', JSON.stringify(conversationHistory, null, 2));
        
        // ‡∏™‡πà‡∏á history ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏£‡∏ß‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° (‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡πà‡∏ô‡∏ô‡∏µ‡πâ backend)
        const historyToSend = conversationHistory.slice(0, -1);  // ‡∏ï‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏ß‡πà‡∏≤ API ‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö message ‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å
        
        console.log('[CHAT] Sending history with', historyToSend.length, 'messages');
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÅ‡∏ä‡∏ó
        fetch('/api/chat/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
            },
            body: JSON.stringify({ 
                message: message,
                conversation_history: historyToSend
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addChatMessage(data.message, false);
            } else {
                addChatMessage('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (data.error || '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏'), false);
            }
        })
        .catch(error => {
            console.error('Chat error:', error);
            addChatMessage('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ', false);
        })
        .finally(() => {
            isSending = false;
            chatSendBtn.disabled = false;
        });
    });

    // Clear chat history
    clearChatBtn.addEventListener('click', function() {
        if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤?')) {
            conversationHistory = [];
            localStorage.removeItem('chatHistory');
            chatMessages.innerHTML = '<div class="text-[#8b8ba8] text-center text-xs py-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤...</div>';
            console.log('[CHAT] Chat history cleared');
        }
    });

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !isSending) {
            chatSendBtn.click();
        }
    });

    // ### Category Filter ###
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // ‡∏•‡∏ö active class ‡∏à‡∏≤‡∏Å‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            document.querySelectorAll('.category-btn').forEach(b => {
                b.classList.remove('bg-[#b16cff]', 'text-white');
                b.classList.add('bg-[#3a3d5c]', 'text-[#8b8ba8]');
            });
            
            // ‡πÄ‡∏û‡∏¥‡πà‡∏° active class ‡πÉ‡∏´‡πâ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            this.classList.remove('bg-[#3a3d5c]', 'text-[#8b8ba8]');
            this.classList.add('bg-[#b16cff]', 'text-white');
            
            const categoryId = this.dataset.category;
            const products = document.querySelectorAll('.product-card');
            
            if (categoryId === 'all') {
                // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                products.forEach(product => {
                    product.style.display = 'flex';
                });
            } else {
                // filter ‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î
                products.forEach(product => {
                    const productCategoryId = product.dataset.categoryId;
                    if (productCategoryId === categoryId) {
                        product.style.display = 'flex';
                    } else {
                        product.style.display = 'none';
                    }
                });
            }
        });
    });
    
    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô back button ‡πÅ‡∏•‡∏∞ cache
    window.addEventListener('pageshow', function(event) {
        if (event.persisted) {
            window.location.reload();
        }
    });
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö AI status ‡∏ó‡∏∏‡∏Å 5 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
    setInterval(function() {
        fetch('{% url "home" %}', {
            method: 'HEAD',
            cache: 'no-store'
        }).catch(error => {
            console.log('Connection check');
        });
    }, 5000);
</script>
{% endblock %}